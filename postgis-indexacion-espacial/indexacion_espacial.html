<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Indexación espacial &mdash; Curso de PostGIS 2.0 - PATHII, Tegucigalpa 2013 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Curso de PostGIS 2.0 - PATHII, Tegucigalpa 2013 1.0 documentation" href="../index.html" />
    <link rel="next" title="Importación y exportación de datos" href="../postgis-importacion-exportacion/importacion_exportacion.html" />
    <link rel="prev" title="Ejemplos SFA" href="../postgis-simple-feature-model/ejemplos.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../postgis-importacion-exportacion/importacion_exportacion.html" title="Importación y exportación de datos"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../postgis-simple-feature-model/ejemplos.html" title="Ejemplos SFA"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Curso de PostGIS 2.0 - PATHII, Tegucigalpa 2013 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="indexacion-espacial">
<h1>Indexación espacial<a class="headerlink" href="#indexacion-espacial" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Fecha</th>
<th class="head">Autores</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1 Noviembre 2012</td>
<td><ul class="first last simple">
<li>Micho García (<a class="reference external" href="mailto:micho&#46;garcia&#37;&#52;&#48;geomati&#46;co">micho<span>&#46;</span>garcia<span>&#64;</span>geomati<span>&#46;</span>co</a>)</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>15 Octubre  2013</td>
<td><ul class="first last simple">
<li>Jorge Arévalo(<a class="reference external" href="mailto:jorge&#46;arevalo&#37;&#52;&#48;geomati&#46;co">jorge<span>&#46;</span>arevalo<span>&#64;</span>geomati<span>&#46;</span>co</a>)</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>©2012 Micho García</p>
<p class="last">Excepto donde quede reflejado de otra manera, la presente documentación se halla bajo licencia : Creative Commons (Creative Commons - Attribution - Share Alike: <a class="reference external" href="http://creativecommons.org/licenses/by-sa/3.0/deed.es">http://creativecommons.org/licenses/by-sa/3.0/deed.es</a>)</p>
</div>
<p>La indexación espacial es una de las funcionalidades importantes de las bases de datos espaciales. Los índices consiguen que las búsquedas espaciales en un gran número de datos sean eficientes. Sin indexación, la búsqueda se realizaría de manera secuencial teniendo que buscar en todos los registros de la base de datos. La indexación organiza los datos en una estructura de árbol que es recorrida rápidamente en la búsqueda de un registro.</p>
<div class="section" id="como-funcionan-los-indices-espaciales">
<h2>Como funcionan los índices espaciales<a class="headerlink" href="#como-funcionan-los-indices-espaciales" title="Permalink to this headline">¶</a></h2>
<p>Las base de datos estándar crean un árbol jerárquico basados en los valores de las columnas. Los índices espaciales funcionan de una manera diferente, los índices no son capaces de indexar las geometrías, e indexarán las cajas (box) de las geometrías.</p>
<blockquote>
<div><img alt="../_images/boundingbox.png" src="../_images/boundingbox.png" />
</div></blockquote>
<p>La caja (box) es el rectángulo definido por las máximas y mínimas coordenadas X e Y de una geometría.</p>
<blockquote>
<div><img alt="../_images/bbox.png" src="../_images/bbox.png" />
</div></blockquote>
<p>En la figura se puede observar que solo la linea intersecta a la estrella amarilla, mientras que si utilizamos los índices comprobaremos que la caja amarilla es intersectada por dos figuras la caja roja y la azul. El camino eficiente para responder correctamente a la pregunta <strong>¿qué elemento intersecta la estrella amarilla?</strong> es primero responder a la pregunta <strong>¿qué cajas intersectan la caja amarilla?</strong> usando el índice (consulta rápida) y luego calcular exactamente <strong>¿quien intersecta a la estrella amarilla?</strong> sobre el resultado de la consulta de las cajas.</p>
</div>
<div class="section" id="creacion-de-indices-espaciales">
<h2>Creación de índices espaciales<a class="headerlink" href="#creacion-de-indices-espaciales" title="Permalink to this headline">¶</a></h2>
<p>La sintaxis será la siguiente:</p>
<div class="highlight-python"><pre>CREATE INDEX [Nombre_del_indice] ON [Nombre_de_tabla] USING GIST ([campo_de_geometria]);</pre>
</div>
<p>Esta operación puede requerir bastante tiempo en tablas de gran tamaño.</p>
</div>
<div class="section" id="uso-de-indices-espaciales">
<h2>Uso de índices espaciales<a class="headerlink" href="#uso-de-indices-espaciales" title="Permalink to this headline">¶</a></h2>
<p>La mayor parte de las funciones en PostGIS (ST_Contains, ST_Intersects, ST_DWithin, etc) incluyen un filtrado por índice automáticamente.</p>
<p>Para hacer que una función utilice el índice, hay que hacer uso del operador <strong>&amp;&amp;</strong>. Para las geometrías, el operador <strong>&amp;&amp;</strong> significa &#8220;la caja que toca (touch) o superpone (overlap)&#8221; de la misma manera que para un número el operador <strong>=</strong> significa &#8220;valores iguales&#8221;</p>
</div>
<div class="section" id="ejemplo">
<h2>Ejemplo<a class="headerlink" href="#ejemplo" title="Permalink to this headline">¶</a></h2>
<p>A partir de las capas ríos y suelos calcularemos el número de ríos que intersectan con los tipos de suelo:</p>
<div class="highlight-python"><pre># select count(*) from suelos su, rios ri where (su.geom &amp;&amp; ri.geom) and st_relate(su.geom, ri.geom, 'T********');

  count
----------
  5004</pre>
</div>
<p>Esta consulta tardará del orden de 10s</p>
<blockquote>
<div><p># select count(*) from suelos su, rios ri where (su.geom &amp;&amp; ri.geom)</p>
<blockquote>
<div>count</div></blockquote>
<blockquote>
<div>12739</div></blockquote>
</div></blockquote>
<p>En este último caso ha tardad muy pocos segundos.</p>
<p>Si eliminamos los índices y repetimos la consulta, veremos que el tiempo de cálculo se incrementa</p>
</div>
<div class="section" id="analyze-y-vacuum">
<h2>ANALYZE y VACUUM<a class="headerlink" href="#analyze-y-vacuum" title="Permalink to this headline">¶</a></h2>
<p>El planificador de PostGIS se encarga de mantener estadísticas sobre la distribución de los datos de cada columna de la tabla indexada. Por defecto PostgreSQL ejecuta la estadísticas regularmente. Si hay algún cambio grande en la estructura de las tablas, es recomendable ejecutar un <tt class="docutils literal"><span class="pre">ANALYZE</span></tt> manualmente para actualizar estas estadísticas. Este comando obliga a PostgreSQL a recorrer los datos de las tablas con columnas indexadas y actualizar sus estadísticas internas.</p>
<p>No solo con crear el índice y actualizar las estadísticas obtendremos una manera eficiente de manejar nuestras tablas. La operación  <tt class="docutils literal"><span class="pre">VACUUM</span></tt> debe ser realizada siempre que un indice sea creado o después de un gran número de UPDATEs, INSERTs o DELETEs. El comando <tt class="docutils literal"><span class="pre">VACUUM</span></tt> obliga a PostgreSQL a utilizar el espacio no usado en la tabla que dejan las actualizaciones y los borrados de elementos.</p>
<p>Hacer un <tt class="docutils literal"><span class="pre">VACUUM</span></tt> es crítico para la eficiencia de la base de datos. PostgreSQL dispone de la opción <tt class="docutils literal"><span class="pre">Autovacuum</span></tt>. De esta manera PostgreSQL realizará VACUUMs y ANALYZEs de manera periodica en función de la actividad que haya en la tabla:</p>
<div class="highlight-python"><pre>VACUUM ANALYZE [Nombre_tabla]
VACUUM ANALYZE [Nombre_tabla] ([Nombre_columna])</pre>
</div>
<p>Esta orden actualiza las estadísticas y elimina los datos borrados que se encontraban marcados como eliminados.</p>
</div>
<div class="section" id="planificador">
<h2>Planificador<a class="headerlink" href="#planificador" title="Permalink to this headline">¶</a></h2>
<p>¿Que pasa si ejecutamos la consulta invirtiendo el orden de los predicados?:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># select count(*) from suelos su, rios ri where st_relate(su.geom, ri.geom, &#39;T********&#39;) and (su.geom &amp;&amp; ri.geom);</span>
</pre></div>
</div>
<p>Comprobaremos que el resultado es el mismo, ya que el orden en las consultas es indiferente para PostGIS siendo el planificador el que gestiona esto.</p>
<p>Para utilizar el planificador:</p>
<div class="highlight-python"><pre>EXPLAIN [ ANALYZE ] [ VERBOSE ] sentenciaSQL</pre>
</div>
<ul>
<li><p class="first">ANALYZE ejecuta la consulta y muestra el plan de la misma mientras que si no se indica, PostgreSQL realiza una aproximación:</p>
<blockquote>
<div><p># explain analyze select count(*) from suelos su, rios ri where (su.geom &amp;&amp; ri.geom)</p>
<dl class="docutils">
<dt>Aggregate  (cost=415523.85..415523.86 rows=1 width=0) (actual time=27952.663..27952.664 rows=1 loops=1)</dt>
<dd><dl class="first last docutils">
<dt>-&gt;  Nested Loop  (cost=0.00..415494.59 rows=11703 width=0) (actual time=2.200..27944.733 rows=12379 loops=1)</dt>
<dd><p class="first last">Join Filter: (su.geom &amp;&amp; ri.geom)
-&gt;  Seq Scan on suelos su  (cost=0.00..513.71 rows=3871 width=6752) (actual time=0.007..2.607 rows=3871 loops=1)
-&gt;  Seq Scan on rios ri  (cost=0.00..82.09 rows=2009 width=832) (actual time=0.002..0.958 rows=2009 loops=3871)</p>
</dd>
</dl>
</dd>
</dl>
<p>Total runtime: 27952.715 ms&#8221;</p>
<p># create index suelos_geom_gist on suelos using gist(geom);
# create index rios_geom_gist on rios using gist(geom);</p>
<dl class="docutils">
<dt>Aggregate  (cost=1937.17..1937.18 rows=1 width=0) (actual time=218.263..218.264 rows=1 loops=1)</dt>
<dd><dl class="first last docutils">
<dt>-&gt;  Nested Loop  (cost=0.00..1907.91 rows=11703 width=0) (actual time=0.065..213.180 rows=12379 loops=1)</dt>
<dd><p class="first">-&gt;  Seq Scan on suelos su  (cost=0.00..513.71 rows=3871 width=6752) (actual time=0.005..2.644 rows=3871 loops=1)
<strong>-&gt;  Index Scan using rios_geom_gist on rios ri</strong>  (cost=0.00..0.35 rows=1 width=832) (actual time=0.035..0.045 rows=3 loops=3871)</p>
<blockquote class="last">
<div><p>Index Cond: (su.geom &amp;&amp; geom)&#8221;</p>
</div></blockquote>
</dd>
</dl>
</dd>
</dl>
<p>Total runtime: 218.310 ms</p>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="operador-embebido">
<h2>Operador embebido<a class="headerlink" href="#operador-embebido" title="Permalink to this headline">¶</a></h2>
<p>En el ejemplo anterior se realizaba la consulta con la función ST_Relate que no hace uso de los índices espaciales, de ahí que le hayamos forzado el uso mediante el operador de caja. ¿Qué resultado muestra el planificador si utilizamos simplemente ST_Intersects?</p>
<blockquote>
<div><dl class="docutils">
<dt>Aggregate  (cost=2885.42..2885.43 rows=1 width=0) (actual time=1791.892..1791.892 rows=1 loops=1)</dt>
<dd><dl class="first last docutils">
<dt>-&gt;  Nested Loop  (cost=0.00..2875.66 rows=3901 width=0) (actual time=0.806..1786.258 rows=5004 loops=1)</dt>
<dd><p class="first">Join Filter: _st_intersects(su.geom, ri.geom)
-&gt;  Seq Scan on suelos su  (cost=0.00..513.71 rows=3871 width=6752) (actual time=0.007..4.484 rows=3871 loops=1)
<strong>-&gt;  Index Scan using rios_geom_gist on rios ri</strong>  (cost=0.00..0.35 rows=1 width=832) (actual time=0.031..0.045 rows=3 loops=3871)</p>
<blockquote class="last">
<div>Index Cond: (su.geom &amp;&amp; geom)</div></blockquote>
</dd>
</dl>
</dd>
</dl>
<p>Total runtime: 1791.959 ms</p>
</div></blockquote>
<p>Vemos que es un resultado similar al anterior y que hace uso del operador de caja. Esto es porque en la definición de la función, ya lleva embebido la llamada al operador de caja:</p>
<div class="highlight-python"><pre>CREATE OR REPLACE FUNCTION st_intersects(geom1 geometry, geom2 geometry)
        RETURNS boolean AS
'SELECT **$1 &amp;&amp; $2** AND _ST_Intersects($1,$2)'
 LANGUAGE sql IMMUTABLE
        COST 100;
ALTER FUNCTION st_intersects(geometry, geometry)
OWNER TO alumno;
COMMENT ON FUNCTION st_intersects(geometry, geometry) IS 'args: geomA, geomB - Returns TRUE if the Geometries/Geography "spatially intersect in 2D" - (share any portion of space) and FALSE if they dont (they are Disjoint). For geography -- tolerance is 0.00001 meters (so any points that close are considered to intersect)';</pre>
</div>
<p>Esta función en SQL lo que hace es llamar a una función _ST_Intersects cuya definición será:</p>
<div class="highlight-python"><pre>CREATE OR REPLACE FUNCTION _st_intersects(geom1 geometry, geom2 geometry)
        RETURNS boolean AS
'$libdir/postgis-2.0', 'intersects'
 LANGUAGE c IMMUTABLE STRICT
        COST 100;
ALTER FUNCTION _st_intersects(geometry, geometry)
OWNER TO alumno;</pre>
</div>
<p>Que es la que se comunica directamente con la librería GEOS.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Indexación espacial</a><ul>
<li><a class="reference internal" href="#como-funcionan-los-indices-espaciales">Como funcionan los índices espaciales</a></li>
<li><a class="reference internal" href="#creacion-de-indices-espaciales">Creación de índices espaciales</a></li>
<li><a class="reference internal" href="#uso-de-indices-espaciales">Uso de índices espaciales</a></li>
<li><a class="reference internal" href="#ejemplo">Ejemplo</a></li>
<li><a class="reference internal" href="#analyze-y-vacuum">ANALYZE y VACUUM</a></li>
<li><a class="reference internal" href="#planificador">Planificador</a></li>
<li><a class="reference internal" href="#operador-embebido">Operador embebido</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../postgis-simple-feature-model/ejemplos.html"
                        title="previous chapter">Ejemplos SFA</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../postgis-importacion-exportacion/importacion_exportacion.html"
                        title="next chapter">Importación y exportación de datos</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/postgis-indexacion-espacial/indexacion_espacial.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../postgis-importacion-exportacion/importacion_exportacion.html" title="Importación y exportación de datos"
             >next</a> |</li>
        <li class="right" >
          <a href="../postgis-simple-feature-model/ejemplos.html" title="Ejemplos SFA"
             >previous</a> |</li>
        <li><a href="../index.html">Curso de PostGIS 2.0 - PATHII, Tegucigalpa 2013 1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Micho García.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>